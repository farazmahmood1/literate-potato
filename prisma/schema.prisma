generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CLIENT
  LAWYER
  ADMIN
}

enum ConsultationStatus {
  PENDING
  TRIAL
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum MessageType {
  TEXT
  SYSTEM
  IMAGE
  DOCUMENT
}

enum ServiceOfferStatus {
  PENDING
  ACCEPTED
  DECLINED
  COMPLETED
  CANCELLED
}

enum JobPostStatus {
  OPEN
  ACCEPTED
  CLOSED
  EXPIRED
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTIONED
  DISMISSED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DisputeStatus {
  OPEN
  LAWYER_RESPONSE
  MEDIATION
  ESCALATED
  RESOLVED
  CLOSED
}

enum DisputeCategory {
  QUALITY
  COMMUNICATION
  BILLING
  CONDUCT
  INCOMPLETE
  OTHER
}

enum DisputeResolutionType {
  FULL_REFUND
  PARTIAL_REFUND
  NO_REFUND
  MUTUAL_AGREEMENT
  DISMISSED
}

model User {
  id              String    @id @default(uuid())
  clerkId         String    @unique
  email           String    @unique
  firstName       String
  lastName        String
  phone           String?
  avatar          String?
  role            Role      @default(CLIENT)
  isVerified      Boolean   @default(false)
  suspended       Boolean   @default(false)
  expoPushToken   String?
  lastActiveAt    DateTime?
  notificationPreferences Json?
  registrationState  String?
  registrationCity   String?
  registrationIp     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  lawyerProfile         LawyerProfile?
  consultationsAsClient Consultation[]  @relation("ClientConsultations")
  payments              Payment[]
  reviews               Review[]
  messages              Message[]       @relation("UserMessages")
  reportsGiven          Report[]        @relation("ReportsGiven")
  reportsReceived       Report[]        @relation("ReportsReceived")
  blocksGiven           Block[]         @relation("BlocksGiven")
  blocksReceived        Block[]         @relation("BlocksReceived")
  savedLawyers          SavedLawyer[]   @relation("UserSavedLawyers")
  referralsGiven        Referral[]      @relation("ReferralsGiven")
  referralsReceived     Referral[]      @relation("ReferralsReceived")
  jobPosts              JobPost[]       @relation("ClientJobPosts")
  callsInitiated        Call[]          @relation("CallsInitiated")
  callsReceived         Call[]          @relation("CallsReceived")
  disputesFiled         Dispute[]       @relation("DisputesFiled")
  disputesReceived      Dispute[]       @relation("DisputesReceived")
  disputesResolved      Dispute[]       @relation("DisputesResolved")
  evidenceSubmitted     DisputeEvidence[] @relation("EvidenceSubmitted")
  disputeEvents         DisputeEvent[]  @relation("DisputeEventActors")
  notifications         Notification[]
  supportTickets        SupportTicket[]
  ticketReplies         TicketReply[]

  @@map("users")
}

model LawyerProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  barNumber           String   @unique
  licenseState        String
  title               String?
  specializations     String[]
  bio                 String?
  professionalSummary String?
  yearsExperience     Int      @default(0)
  consultationRate    Int      @default(3000) // in cents
  languages           String[] @default(["English"])
  isAvailable         Boolean  @default(true)
  onlineStatus        String   @default("offline") // "online" | "offline" | "busy"
  rating              Float    @default(0)
  totalReviews        Int      @default(0)
  stripeAccountId     String?
  verificationStatus  String   @default("PENDING") // "PENDING" | "VERIFIED" | "REJECTED"
  education           Json?    // [{institution, degree, year}]
  previousFirms       Json?    // [{name, role, years}]
  certifications      Json?    // [{name, issuer, year}]
  courtLevels         String[] @default([])
  linkedInUrl         String?
  profilePhoto        String?
  licenseImage        String?
  idImage             String?
  lastActiveAt        DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultations    Consultation[] @relation("LawyerConsultations")
  reviews          Review[]
  serviceOffers    ServiceOffer[]
  savedByUsers     SavedLawyer[]  @relation("LawyerSavedByUsers")
  acceptedJobPosts  JobPost[]      @relation("AcceptedJobPosts")
  targetedJobPosts  JobPost[]      @relation("TargetedJobPosts")
  jobPostViews      JobPostView[]  @relation("LawyerJobPostViews")

  @@map("lawyer_profiles")
}

model Consultation {
  id          String             @id @default(uuid())
  clientId    String
  lawyerId    String
  category    String
  description String
  status        ConsultationStatus @default(PENDING)
  requestedType String?            // null = messaging only, 'audio' or 'video' = formal consultation request
  startedAt     DateTime?
  endedAt       DateTime?
  trialEndAt    DateTime?
  summary     Json?
  scheduledAt DateTime?
  isScheduled Boolean            @default(false)
  notes       String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  client        User             @relation("ClientConsultations", fields: [clientId], references: [id])
  lawyer        LawyerProfile    @relation("LawyerConsultations", fields: [lawyerId], references: [id])
  payment       Payment?
  review        Review?
  messages      Message[]
  serviceOffers ServiceOffer[]
  jobPost       JobPost?       @relation("JobPostConsultation")
  calls         Call[]
  disputes      Dispute[]

  @@map("consultations")
}

model Message {
  id              String      @id @default(uuid())
  consultationId  String
  senderId        String
  content         String
  messageType     MessageType @default(TEXT)
  isRead          Boolean     @default(false)
  readAt          DateTime?
  fileUrl         String?
  fileName        String?
  fileSize        Int?
  mimeType        String?
  replyToId       String?
  createdAt       DateTime    @default(now())

  consultation    Consultation @relation(fields: [consultationId], references: [id])
  sender          User         @relation("UserMessages", fields: [senderId], references: [id])
  replyTo         Message?     @relation("MessageReplies", fields: [replyToId], references: [id])
  replies         Message[]    @relation("MessageReplies")

  @@index([consultationId, createdAt])
  @@map("messages")
}

model Payment {
  id               String        @id @default(uuid())
  userId           String
  consultationId   String        @unique
  stripePaymentId  String?       @unique
  amount           Int           // in cents
  status           PaymentStatus @default(PENDING)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user             User          @relation(fields: [userId], references: [id])
  consultation     Consultation  @relation(fields: [consultationId], references: [id])

  @@map("payments")
}

model Review {
  id              String        @id @default(uuid())
  consultationId  String        @unique
  reviewerId      String
  lawyerProfileId String
  rating          Int
  comment         String?
  status          ReviewStatus  @default(PENDING)
  rejectionReason String?
  reviewedAt      DateTime?
  createdAt       DateTime      @default(now())

  consultation    Consultation  @relation(fields: [consultationId], references: [id])
  reviewer        User          @relation(fields: [reviewerId], references: [id])
  lawyerProfile   LawyerProfile @relation(fields: [lawyerProfileId], references: [id])

  @@index([status])
  @@map("reviews")
}

model ServiceOffer {
  id              String             @id @default(uuid())
  consultationId  String
  lawyerId        String
  title           String
  description     String
  price           Int                // cents
  estimatedDays   Int?
  status          ServiceOfferStatus @default(PENDING)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  consultation    Consultation       @relation(fields: [consultationId], references: [id])
  lawyer          LawyerProfile      @relation(fields: [lawyerId], references: [id])

  @@map("service_offers")
}

model SavedLawyer {
  id              String   @id @default(uuid())
  userId          String
  lawyerProfileId String
  createdAt       DateTime @default(now())

  user            User          @relation("UserSavedLawyers", fields: [userId], references: [id], onDelete: Cascade)
  lawyerProfile   LawyerProfile @relation("LawyerSavedByUsers", fields: [lawyerProfileId], references: [id], onDelete: Cascade)

  @@unique([userId, lawyerProfileId])
  @@map("saved_lawyers")
}

model Report {
  id          String       @id @default(uuid())
  reporterId  String
  reportedId  String
  reason      String
  description String?
  status      ReportStatus @default(PENDING)
  createdAt   DateTime     @default(now())

  reporter    User @relation("ReportsGiven", fields: [reporterId], references: [id])
  reported    User @relation("ReportsReceived", fields: [reportedId], references: [id])

  @@map("reports")
}

model Block {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  blocker   User @relation("BlocksGiven", fields: [blockerId], references: [id])
  blocked   User @relation("BlocksReceived", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId])
  @@map("blocks")
}

model Referral {
  id          String   @id @default(uuid())
  referrerId  String
  refereeId   String?
  code        String   @unique
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  referrer    User     @relation("ReferralsGiven", fields: [referrerId], references: [id])
  referee     User?    @relation("ReferralsReceived", fields: [refereeId], references: [id])

  @@map("referrals")
}

model Promotion {
  id            String   @id @default(uuid())
  code          String   @unique
  description   String
  discountType  String   // "PERCENTAGE" | "FIXED"
  discountValue Int      // percentage (50) or cents (1500)
  validFrom     DateTime
  validTo       DateTime
  maxUses       Int?
  currentUses   Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  @@map("promotions")
}

model JobPost {
  id                 String        @id @default(uuid())
  clientId           String
  category           String
  state              String
  urgency            String        @default("medium")
  description        String
  summary            String
  status             JobPostStatus @default(OPEN)
  lawyersNotified    Int           @default(0)
  onlineLawyersCount Int           @default(0)
  acceptedByLawyerId String?
  consultationId     String?       @unique
  targetLawyerId     String?
  expiresAt          DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  client             User           @relation("ClientJobPosts", fields: [clientId], references: [id])
  acceptedByLawyer   LawyerProfile? @relation("AcceptedJobPosts", fields: [acceptedByLawyerId], references: [id])
  targetLawyer       LawyerProfile? @relation("TargetedJobPosts", fields: [targetLawyerId], references: [id])
  consultation       Consultation?  @relation("JobPostConsultation", fields: [consultationId], references: [id])
  views              JobPostView[]  @relation("JobPostViews")

  @@index([state, status])
  @@map("job_posts")
}

model JobPostView {
  id         String   @id @default(uuid())
  jobPostId  String
  lawyerId   String
  lawyerName String
  declined   Boolean  @default(false)
  viewedAt   DateTime @default(now())

  jobPost JobPost       @relation("JobPostViews", fields: [jobPostId], references: [id], onDelete: Cascade)
  lawyer  LawyerProfile @relation("LawyerJobPostViews", fields: [lawyerId], references: [id], onDelete: Cascade)

  @@unique([jobPostId, lawyerId])
  @@map("job_post_views")
}

model Call {
  id              String   @id @default(uuid())
  consultationId  String
  initiatorId     String
  receiverId      String
  type            String   // "voice" | "video"
  status          String   @default("RINGING") // RINGING | ACTIVE | ENDED | DECLINED | MISSED
  channelName     String   @unique
  initiatorUid    Int
  receiverUid     Int
  initiatorName   String
  receiverName    String
  startedAt       DateTime?
  endedAt         DateTime?
  duration        Int?     // seconds
  createdAt       DateTime @default(now())

  consultation    Consultation @relation(fields: [consultationId], references: [id])
  initiator       User         @relation("CallsInitiated", fields: [initiatorId], references: [id])
  receiver        User         @relation("CallsReceived", fields: [receiverId], references: [id])

  @@index([consultationId])
  @@index([status])
  @@map("calls")
}

model Dispute {
  id                String                 @id @default(uuid())
  consultationId    String
  filedById         String
  filedAgainstId    String
  category          DisputeCategory
  description       String
  status            DisputeStatus          @default(OPEN)
  resolutionType    DisputeResolutionType?
  resolutionNote    String?
  refundAmount      Int?
  stripeRefundId    String?
  resolvedById      String?
  resolvedAt        DateTime?
  lawyerDeadline    DateTime?
  mediationDeadline DateTime?
  proposedBy        String?
  proposedResolution Json?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  consultation      Consultation           @relation(fields: [consultationId], references: [id])
  filedBy           User                   @relation("DisputesFiled", fields: [filedById], references: [id])
  filedAgainst      User                   @relation("DisputesReceived", fields: [filedAgainstId], references: [id])
  resolvedBy        User?                  @relation("DisputesResolved", fields: [resolvedById], references: [id])
  evidence          DisputeEvidence[]
  timeline          DisputeEvent[]

  @@index([consultationId])
  @@index([status])
  @@map("disputes")
}

model DisputeEvidence {
  id            String   @id @default(uuid())
  disputeId     String
  submittedById String
  type          String   // "text" | "image" | "document"
  content       String
  fileName      String?
  mimeType      String?
  createdAt     DateTime @default(now())

  dispute       Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  submittedBy   User     @relation("EvidenceSubmitted", fields: [submittedById], references: [id])

  @@map("dispute_evidence")
}

model DisputeEvent {
  id          String   @id @default(uuid())
  disputeId   String
  actorId     String?
  action      String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())

  dispute     Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  actor       User?    @relation("DisputeEventActors", fields: [actorId], references: [id])

  @@index([disputeId, createdAt])
  @@map("dispute_events")
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String
  title     String
  body      String
  data      Json?
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, read])
  @@map("notifications")
}

model AdminBroadcast {
  id        String   @id @default(uuid())
  title     String
  body      String
  target    String   // ALL, CLIENTS, LAWYERS
  sentBy    String
  sentCount Int      @default(0)
  createdAt DateTime @default(now())

  @@index([createdAt(sort: Desc)])
  @@map("admin_broadcasts")
}

model AdminTodo {
  id          String    @id @default(uuid())
  title       String
  description String?
  date        DateTime?
  completed   Boolean   @default(false)
  priority    String    @default("medium")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([date])
  @@index([completed])
  @@map("admin_todos")
}

model SiteVisit {
  id          String   @id @default(uuid())
  fingerprint String
  ipAddress   String
  userAgent   String   @db.Text
  deviceType  String
  path        String
  referrer    String?
  createdAt   DateTime @default(now())

  @@index([fingerprint, createdAt])
  @@index([createdAt])
  @@map("site_visits")
}

// ── Support Tickets ──

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketCategory {
  BILLING
  TECHNICAL
  ACCOUNT
  LEGAL
  OTHER
}

model SupportTicket {
  id          String         @id @default(uuid())
  userId      String
  category    TicketCategory
  subject     String
  description String
  status      TicketStatus   @default(OPEN)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  resolvedAt  DateTime?

  user    User          @relation(fields: [userId], references: [id])
  replies TicketReply[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@map("support_tickets")
}

model TicketReply {
  id        String   @id @default(uuid())
  ticketId  String
  userId    String
  message   String
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id])

  @@index([ticketId, createdAt])
  @@map("ticket_replies")
}

// ── Career Postings (Admin-managed job postings for the company) ──

enum CareerPostingStatus {
  ACTIVE
  CLOSED
  DRAFT
}

enum CareerEmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  REMOTE
}

model CareerPosting {
  id               String               @id @default(uuid())
  title            String
  department       String
  location         String
  employmentType   CareerEmploymentType @default(FULL_TIME)
  description      String               @db.Text
  requirements     String               @db.Text
  salaryMin        Int?                 // annual salary in USD
  salaryMax        Int?
  status           CareerPostingStatus  @default(DRAFT)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  applications     CareerApplication[]

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("career_postings")
}

model CareerApplication {
  id              String   @id @default(uuid())
  postingId       String
  fullName        String
  email           String
  phone           String?
  resumeUrl       String?
  coverLetter     String?  @db.Text
  linkedInUrl     String?
  createdAt       DateTime @default(now())

  posting         CareerPosting @relation(fields: [postingId], references: [id], onDelete: Cascade)

  @@index([postingId, createdAt(sort: Desc)])
  @@map("career_applications")
}
